{% extends "layout.html" %}

{% block title %}ğŸš€ GeliÅŸmiÅŸ Token OluÅŸturucu{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- ğŸ”¥ YENÄ°: YatÄ±rÄ±mcÄ± GÃ¼venliÄŸi Rehberi -->
    <div class="alert alert-info border-0 shadow-sm mb-4">
        <h5 class="alert-heading"><i class="bi bi-shield-check me-2"></i>ğŸ›¡ï¸ YatÄ±rÄ±mcÄ± GÃ¼venliÄŸi Rehberi</h5>
        <div class="row">
            <div class="col-md-6">
                <ul class="mb-0">
                    <li><strong>Mint Authority:</strong> Token yaratma yetkisini kaldÄ±rÄ±n</li>
                    <li><strong>Freeze Authority:</strong> Token dondurma yetkisini devre dÄ±ÅŸÄ± bÄ±rakÄ±n</li>
                    <li><strong>Likidite Kilidi:</strong> LP token'larÄ±nÄ± en az 6 ay kilitleyin</li>
                </ul>
            </div>
            <div class="col-md-6">
                <ul class="mb-0">
                    <li><strong>ÅeffaflÄ±k:</strong> Token detaylarÄ±nÄ± aÃ§Ä±k bir ÅŸekilde belirtin</li>
                    <li><strong>Transfer Ãœcreti:</strong> Makul transfer Ã¼creti belirleyin (%5 max)</li>
                    <li><strong>Audit:</strong> Token kontratÄ±nÄ±zÄ± profesyonellere inceletin</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Ana Token Creator Formu -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h4 class="mb-0"><i class="bi bi-plus-circle me-2"></i>GeliÅŸmiÅŸ Token OluÅŸturucu</h4>
        </div>
        <div class="card-body p-4">
            <form id="tokenCreationForm" class="needs-validation" novalidate>
                
                <!-- Wallet SeÃ§imi -->
                <div class="row mb-4">
                    <div class="col-12">
                        <label class="form-label fw-bold">
                            <i class="bi bi-wallet2 me-2"></i>Wallet SeÃ§imi
                        </label>
                        <select class="form-select" id="walletSelect" name="wallet_id" required>
                            <option value="">Wallet seÃ§in...</option>
                        </select>
                        <div class="form-text">Token oluÅŸturacak ve Ã¼cretleri Ã¶deyecek wallet'Ä± seÃ§in</div>
                    </div>
                </div>

                <!-- ğŸ¨ TOKEN Ä°KONU YÃœKLEME - WALLET SEÃ‡Ä°MÄ°NDEN HEMEN SONRA -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <label class="form-label fw-bold">
                            <i class="bi bi-image me-2"></i>Token Ä°konu (Ä°steÄŸe BaÄŸlÄ±)
                        </label>
                        <input type="file" class="form-control" id="tokenIcon" name="token_icon" 
                               accept="image/png,image/jpeg,image/svg+xml">
                        <div class="form-text">PNG, JPG veya SVG formatÄ±nda. Maksimum 2MB. Ã–nerilen boyut: 512x512px</div>
                    </div>
                    <div class="col-md-4">
                        <div id="iconPreview" class="mt-4" style="display: none;">
                            <img id="previewImage" class="img-thumbnail rounded-circle" 
                                 style="max-width: 80px; max-height: 80px; border: 2px solid #0d6efd;" 
                                 alt="Token Icon Preview">
                        </div>
                    </div>
                </div>

                <!-- Temel Token Bilgileri -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Token AdÄ±</label>
                        <input type="text" class="form-control" id="tokenName" name="token_name" 
                               placeholder="Ã–rnek: MonacoToken" required minlength="3" maxlength="50">
                        <div class="invalid-feedback">Token adÄ± 3-50 karakter arasÄ± olmalÄ±dÄ±r</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Token SembolÃ¼</label>
                        <input type="text" class="form-control" id="tokenSymbol" name="token_symbol" 
                               placeholder="Ã–rnek: MCO" required minlength="2" maxlength="10" style="text-transform: uppercase;">
                        <div class="invalid-feedback">Token sembolÃ¼ 2-10 karakter arasÄ± olmalÄ±dÄ±r</div>
                    </div>
                </div>

                <!-- Decimals ve Initial Supply -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Decimal SayÄ±sÄ±</label>
                        <select class="form-select" id="tokenDecimals" name="decimals" required>
                            <option value="6">6 (Standart)</option>
                            <option value="9" selected>9 (Ã–nerilen)</option>
                            <option value="0">0 (NFT iÃ§in)</option>
                            <option value="2">2 (Para birimi iÃ§in)</option>
                            <option value="18">18 (Ethereum benzeri)</option>
                        </select>
                        <div class="form-text">9 decimal Ã§oÄŸu token iÃ§in Ã¶nerilen deÄŸerdir</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Ä°lk Arz MiktarÄ±</label>
                        <input type="number" class="form-control" id="initialSupply" name="initial_supply" 
                               placeholder="1000000" required min="1" max="1000000000000">
                        <div class="form-text">Token'Ä±n toplam baÅŸlangÄ±Ã§ miktarÄ±</div>
                    </div>
                </div>

                <!-- Token AÃ§Ä±klamasÄ± -->
                <div class="row mb-4">
                    <div class="col-12">
                        <label class="form-label fw-bold">Token AÃ§Ä±klamasÄ±</label>
                        <textarea class="form-control" id="tokenDescription" name="description" 
                                  rows="3" placeholder="Token'Ä±nÄ±zÄ±n amacÄ±nÄ±, kullanÄ±m alanlarÄ±nÄ± ve Ã¶zelliklerini aÃ§Ä±klayÄ±n..."></textarea>
                        <div class="form-text">YatÄ±rÄ±mcÄ±lar iÃ§in net ve aÃ§Ä±k bir aÃ§Ä±klama yazÄ±n</div>
                    </div>
                </div>

                <!-- Creator Bilgileri -->
                <div class="card border-info mb-4">
                    <div class="card-header bg-info bg-opacity-10">
                        <h6 class="mb-0"><i class="bi bi-person-badge me-2"></i>Creator Bilgileri</h6>
                        <small class="text-muted">Token yaratÄ±cÄ±sÄ±nÄ±n bilgileri (DEX'lerde gÃ¶rÃ¼necek)</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Creator Name</label>
                                <input type="text" class="form-control" id="creatorName" name="creator_name" 
                                       placeholder="Token yaratÄ±cÄ±sÄ±nÄ±n adÄ±">
                                <div class="form-text">DEX'lerde gÃ¶rÃ¼necek yaratÄ±cÄ± adÄ±</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Creator Website</label>
                                <input type="url" class="form-control" id="creatorWebsite" name="creator_website" 
                                       placeholder="https://website.com">
                                <div class="form-text">YaratÄ±cÄ±nÄ±n resmi web sitesi</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ğŸ”¥ SOLANA AÄININ TÃœM TOKEN Ã–ZELLÄ°KLERÄ° -->
                <div class="card border-warning mb-4">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h6 class="mb-0"><i class="bi bi-shield-exclamation me-2"></i>Solana Token Ã–zellikleri</h6>
                        <small class="text-muted">Token oluÅŸtururken yapÄ±lacak seÃ§imler</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="mintAuthority" name="mint_authority" checked>
                                    <label class="form-check-label fw-bold" for="mintAuthority">
                                        <i class="bi bi-plus-circle me-2"></i>Mint Yetkisi (Yeni token Ã¼retimi)
                                    </label>
                                    <div class="form-text">Token sahibi olarak yeni token yaratabilme yetkisi. âœ… Kontrol iÃ§in Ã¶nerilir.</div>
                                </div>
                            </div>
                            <div class="col-12 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="freezeAuthority" name="freeze_authority">
                                    <label class="form-check-label fw-bold" for="freezeAuthority">
                                        <i class="bi bi-snow me-2"></i>Freeze Yetkisi (Hesap dondurma)
                                    </label>
                                    <div class="form-text">Belirli hesaplarÄ± dondurabilme yetkisi. âš ï¸ YatÄ±rÄ±mcÄ±lar iÃ§in riskli olabilir.</div>
                                </div>
                            </div>
                            <div class="col-12 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="transferFeeEnabled" name="transfer_fee_enabled">
                                    <label class="form-check-label fw-bold" for="transferFeeEnabled">
                                        <i class="bi bi-percent me-2"></i>Transfer Ãœcreti
                                    </label>
                                    <div class="form-text">Her transfer iÅŸleminde alÄ±nacak Ã¼cret. ğŸ’° Gelir modeli iÃ§in kullanÄ±labilir.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Transfer Ãœcreti DetaylarÄ± -->
                        <div id="transferFeeDetails" class="border rounded p-3 bg-light" style="display: none;">
                            <h6><i class="bi bi-gear me-2"></i>Transfer Ãœcreti AyarlarÄ±</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Ãœcret OranÄ± (%)</label>
                                    <input type="number" class="form-control" id="transferFeeRate" name="transfer_fee_rate" 
                                           value="0.5" min="0.01" max="10" step="0.01">
                                    <div class="form-text">0.01% - 10% arasÄ±</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Maksimum Ãœcret</label>
                                    <input type="number" class="form-control" id="maxTransferFee" name="max_transfer_fee" 
                                           value="1000000" min="1" step="1">
                                    <div class="form-text">Token cinsinden maksimum Ã¼cret</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Ãœcret AlÄ±cÄ±</label>
                                    <select class="form-select" id="feeRecipient" name="fee_recipient">
                                        <option value="">SeÃ§ilen wallet</option>
                                    </select>
                                    <div class="form-text">Ãœcretlerin gideceÄŸi hesap</div>
                                </div>
                            </div>
                        </div>

                        <!-- GeliÅŸmiÅŸ GÃ¼venlik Ã–nerileri -->
                        <div class="alert alert-info mt-3 mb-0">
                            <small>
                                <strong>ğŸ’¡ YatÄ±rÄ±mcÄ± GÃ¼veni Ä°Ã§in Ã–neriler:</strong><br>
                                â€¢ <strong>Mint Yetkisi:</strong> Token tamamlandÄ±ÄŸÄ±nda kaldÄ±rÄ±n (rug pull korumasÄ±)<br>
                                â€¢ <strong>Freeze Yetkisi:</strong> Sadece dÃ¼zenleyici gereklilik varsa aktif edin<br>
                                â€¢ <strong>Transfer Ãœcreti:</strong> %1'den dÃ¼ÅŸÃ¼k tutun, yÃ¼ksek Ã¼cretler kullanÄ±cÄ±larÄ± kaÃ§Ä±rÄ±r
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Maliyet Bilgisi -->
                <div class="alert alert-warning border-0 mb-4">
                    <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Maliyet Bilgisi</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Token OluÅŸturma:</strong> ~0.002 SOL<br>
                            <strong>Metadata YÃ¼kleme:</strong> ~0.001 SOL
                        </div>
                        <div class="col-md-6">
                            <strong>Toplam Tahmini:</strong> ~0.003 SOL<br>
                            <small class="text-muted">GerÃ§ek maliyet aÄŸ yoÄŸunluÄŸuna gÃ¶re deÄŸiÅŸebilir</small>
                        </div>
                    </div>
                </div>

                <!-- Token OluÅŸtur Butonu -->
                <div class="d-grid">
                    <button type="submit" class="btn btn-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                        <i class="bi bi-rocket me-2"></i>Token OluÅŸtur
                        <div class="spinner-border spinner-border-sm ms-2 d-none" id="createTokenSpinner"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- SonuÃ§ AlanÄ± -->
    <div id="tokenCreationResult" class="mt-4" style="display: none;"></div>
</div>

<!-- Token Creator JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Token Creator yÃ¼kleniyor...');
    
    // Wallet'larÄ± yÃ¼kle
    loadWalletsForTokenCreator();
    
    // Form validation - GÃœVENLÄ° KONTROL
    const form = document.getElementById('tokenCreationForm');
    if (form) {
        form.addEventListener('submit', handleTokenCreation);
    }
    
    // Ä°kon Ã¶nizleme
    const iconInput = document.getElementById('tokenIcon');
    if (iconInput) {
        iconInput.addEventListener('change', handleIconPreview);
    }
    
    // Creator Metadata checkbox kontrolÃ¼ - YENÄ° EKLENEN
    const enableCreatorInfoCheckbox = document.getElementById('enableCreatorInfo');
    const creatorInfoFields = document.getElementById('creatorInfoFields');
    
    if (enableCreatorInfoCheckbox && creatorInfoFields) {
        enableCreatorInfoCheckbox.addEventListener('change', function() {
            if (this.checked) {
                creatorInfoFields.style.display = 'block';
                // Required attribute'larÄ± ekle
                document.getElementById('creatorName').setAttribute('required', 'required');
                document.getElementById('creatorWebsite').setAttribute('required', 'required');
            } else {
                creatorInfoFields.style.display = 'none';
                // Required attribute'larÄ± kaldÄ±r
                document.getElementById('creatorName').removeAttribute('required');
                document.getElementById('creatorWebsite').removeAttribute('required');
            }
        });
    }

    // Transfer Ã¼creti checkbox kontrolÃ¼ - GÃœVENLÄ° KONTROLLER
    const transferFeeEnabledCheckbox = document.getElementById('transferFeeEnabled');
    const transferFeeDetails = document.getElementById('transferFeeDetails');
    
    if (transferFeeEnabledCheckbox && transferFeeDetails) {
        transferFeeEnabledCheckbox.addEventListener('change', function() {
            const transferFeeRate = document.getElementById('transferFeeRate');
            if (this.checked) {
                transferFeeDetails.style.display = 'block';
                if (transferFeeRate) transferFeeRate.required = true;
            } else {
                transferFeeDetails.style.display = 'none';
                if (transferFeeRate) transferFeeRate.required = false;
            }
        });
    }
});

async function loadWalletsForTokenCreator() {
    try {
        const response = await fetch('/api/wallets');
        const data = await response.json();
        
        if (data.success && data.data) {
            const walletSelect = document.getElementById('walletSelect');
            const feeRecipient = document.getElementById('feeRecipient');
            
            // Wallet seÃ§imi iÃ§in gÃ¼venli loading
            if (walletSelect) {
                // Mevcut seÃ§enekleri temizle (ilk seÃ§enek hariÃ§)
                while (walletSelect.children.length > 1) {
                    walletSelect.removeChild(walletSelect.lastChild);
                }
                
                data.data.forEach(wallet => {
                    const option = document.createElement('option');
                    option.value = wallet.id;
                    option.textContent = `${wallet.name} (${wallet.balance.toFixed(3)} SOL)`;
                    walletSelect.appendChild(option);
                });
            }
            
            // Fee recipient iÃ§in gÃ¼venli loading
            if (feeRecipient) {
                // Mevcut seÃ§enekleri temizle (ilk seÃ§enek hariÃ§)
                while (feeRecipient.children.length > 1) {
                    feeRecipient.removeChild(feeRecipient.lastChild);
                }
                
                data.data.forEach(wallet => {
                    const option = document.createElement('option');
                    option.value = wallet.id;
                    option.textContent = `${wallet.name} (${wallet.balance.toFixed(3)} SOL)`;
                    feeRecipient.appendChild(option);
                });
            }
            
            console.log(`âœ… ${data.data.length} wallet yÃ¼klendi`);
        }
    } catch (error) {
        console.error('Wallet yÃ¼kleme hatasÄ±:', error);
    }
}

function handleIconPreview(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('iconPreview');
    const previewImage = document.getElementById('previewImage');
    
    if (file) {
        if (file.size > 2 * 1024 * 1024) {
            showNotification('Dosya boyutu 2MB\'dan bÃ¼yÃ¼k olamaz', 'error');
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImage.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
    }
}

async function handleTokenCreation(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    const spinner = document.getElementById('createTokenSpinner');
    
    // Butonu devre dÄ±ÅŸÄ± bÄ±rak ve spinner gÃ¶ster
    submitBtn.disabled = true;
    spinner.classList.remove('d-none');
    
    try {
        const response = await fetch('/api/create-token', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        displayTokenCreationResult(result);
        
    } catch (error) {
        console.error('Token oluÅŸturma hatasÄ±:', error);
        displayTokenCreationResult({
            success: false,
            message: 'Token oluÅŸturma sÄ±rasÄ±nda bir hata oluÅŸtu',
            error: error.message
        });
    } finally {
        // Butonu tekrar etkinleÅŸtir ve spinner gizle
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
    }
}

function displayTokenCreationResult(result) {
    const resultDiv = document.getElementById('tokenCreationResult');
    
    if (result.success) {
        resultDiv.innerHTML = `
            <div class="alert alert-success border-0 shadow-sm">
                <h5 class="alert-heading"><i class="bi bi-check-circle me-2"></i>Token BaÅŸarÄ±yla OluÅŸturuldu!</h5>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Token Adresi:</strong><br>
                        <code class="user-select-all">${result.token_address || 'Adres alÄ±nÄ±yor...'}</code>
                    </div>
                    <div class="col-md-6">
                        <strong>Ä°ÅŸlem ID:</strong><br>
                        <code class="user-select-all">${result.transaction_id || 'Ä°ÅŸlem ID alÄ±nÄ±yor...'}</code>
                    </div>
                </div>
                <hr>
                <div class="d-flex gap-2 mt-3">
                    <a href="/tokens" class="btn btn-primary">Token Listesini GÃ¶rÃ¼ntÃ¼le</a>
                    <button class="btn btn-outline-primary" onclick="copyToClipboard('${result.token_address}')">
                        Adresi Kopyala
                    </button>
                </div>
            </div>
        `;
    } else {
        resultDiv.innerHTML = `
            <div class="alert alert-danger border-0 shadow-sm">
                <h5 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Token OluÅŸturulamadÄ±</h5>
                <p class="mb-0">${result.message || 'Bilinmeyen bir hata oluÅŸtu'}</p>
                ${result.error ? `<pre class="mt-2 text-muted"><small>${result.error}</small></pre>` : ''}
            </div>
        `;
    }
    
    resultDiv.style.display = 'block';
    resultDiv.scrollIntoView({ behavior: 'smooth' });
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Toast gÃ¶ster
        const toast = document.createElement('div');
        toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 1100;';
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">Adres kopyalandÄ±!</div>
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.remove(), 3000);
    });
}

// Creator Metadata dinamik kontrolÃ¼
document.addEventListener('DOMContentLoaded', function() {
    // Creator info checkbox kontrolÃ¼
    const enableCreatorInfo = document.getElementById('enableCreatorInfo');
    const creatorInfoFields = document.getElementById('creatorInfoFields');
    
    if (enableCreatorInfo && creatorInfoFields) {
        enableCreatorInfo.addEventListener('change', function() {
            if (this.checked) {
                creatorInfoFields.style.display = 'block';
                // Required alanlarÄ± aktif et
                document.getElementById('creatorName').setAttribute('required', 'required');
                document.getElementById('creatorWebsite').setAttribute('required', 'required');
            } else {
                creatorInfoFields.style.display = 'none';
                // Required alanlarÄ± pasif et
                document.getElementById('creatorName').removeAttribute('required');
                document.getElementById('creatorWebsite').removeAttribute('required');
            }
        });
    }
    
    // Enhanced token creator entegrasyonu
    if (typeof enhancedTokenCreator !== 'undefined') {
        console.log('âœ… Enhanced Token Creator integration successful');
    }
});
</script>

<!-- Enhanced Token Creator Script -->
<script src="/static/js/enhanced-token-creator.js"></script>

{% endblock %}